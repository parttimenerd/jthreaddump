{{> partials/header}}
<header>
    <div class="container">
        <h1>Similar Stack Analysis</h1>
        <span class="severity-badge severity-{{lowercase severity}}">{{severity}}</span>
        {{#if isMultiDump}}<span class="severity-badge severity-info">Multi-Dump</span>{{/if}}
    </div>
</header>
<div class="container">
    <div class="card">
        <h2>Summary</h2>
        <div class="stat-grid">
            <div class="stat-item">
                <div class="stat-value">{{groupCount}}</div>
                <div class="stat-label">Similar Groups</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{totalGroupedThreads}}</div>
                <div class="stat-label">Total Threads</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{prefixDepth}}</div>
                <div class="stat-label">Prefix Depth</div>
            </div>
        </div>
    </div>

    {{#if hasEvolution}}
    <!-- Evolution Summary -->
    <div class="card">
        <h2>Pattern Evolution Summary</h2>
        <div class="stat-grid">
            <div class="stat-item">
                <div class="stat-value" style="{{#ifGt growingPatternCount 0}}color: var(--color-warning);{{/ifGt}}">{{growingPatternCount}}</div>
                <div class="stat-label">Growing Patterns</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" style="{{#ifGt shrinkingPatternCount 0}}color: var(--color-ok);{{/ifGt}}">{{shrinkingPatternCount}}</div>
                <div class="stat-label">Shrinking Patterns</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" style="{{#ifGt migratingPatternCount 0}}color: var(--color-info);{{/ifGt}}">{{migratingPatternCount}}</div>
                <div class="stat-label">Thread Migration</div>
            </div>
        </div>
    </div>

    <!-- Evolution Timeline -->
    <div class="card">
        <h2>Patterns Over Time</h2>
        <div class="chart-row">
            <div class="chart-container">
                <canvas id="patternTimeline"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="threadTimeline"></canvas>
            </div>
        </div>
    </div>

    <!-- Pattern Evolution Table -->
    <div class="card">
        <h2>Pattern Evolution Details</h2>
        <table class="trend-table">
            <thead>
                <tr>
                    <th>Entry Point</th>
                    <th>Trend</th>
                    <th>Stability</th>
                    <th>First</th>
                    <th>Last</th>
                    <th>Change</th>
                    <th>Dumps</th>
                </tr>
            </thead>
            <tbody>
                {{#each evolvingPatterns}}
                <tr style="{{#if isGrowing}}background: #fff3cd;{{else}}{{#if hasMigration}}background: #e7f3ff;{{/if}}{{/if}}">
                    <td><code style="font-size: 0.85rem;">{{entryPoint}}</code></td>
                    <td>
                        <span class="thread-badge {{#if isGrowing}}warning{{else}}{{#if isShrinking}}ok{{else}}{{#if hasMigration}}info{{else}}blocked{{/if}}{{/if}}{{/if}}">
                            {{trend}}
                        </span>
                    </td>
                    <td>
                        <span class="thread-badge {{#if hasMigration}}warning{{else}}ok{{/if}}">
                            {{stabilityScore}}%
                        </span>
                    </td>
                    <td>{{firstSize}}</td>
                    <td>{{lastSize}}</td>
                    <td>
                        <strong style="color: {{#if isGrowing}}#ffc107{{else}}{{#if isShrinking}}#28a745{{else}}#666{{/if}}{{/if}};">
                            {{sizeChangeDisplay}}
                        </strong>
                    </td>
                    <td>{{firstDump}} â†’ {{lastDump}}</td>
                </tr>
                {{/each}}
            </tbody>
        </table>
    </div>
    {{/if}}

    {{#if hasGroups}}
    <div class="card">
        <h2>Entry Point Distribution</h2>
        <div class="chart-row">
            <div class="chart-container">
                <canvas id="entryPointBar"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="entryPointPie"></canvas>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>Entry Point Groups</h2>
        {{#each groups}}
        <details style="margin-bottom: 12px;" {{#ifGt threadCount 10}}open{{/ifGt}}>
            <summary style="{{#ifGt threadCount 10}}background: #fff3cd;{{/if}}">
                <strong>{{entryPoint}}</strong> - {{threadCount}} threads ({{uniqueStackCount}} unique stacks)
            </summary>
            <div style="padding: 16px;">
                <h4>Entry Point Path</h4>
                <div class="stack-trace" style="margin-bottom: 16px;">{{#each prefixFrames}}at {{this}}
{{/each}}</div>

                <h4>Threads</h4>
                <div>
                    {{#each displayedThreadNames}}
                    <span class="thread-badge">{{this}}</span>
                    {{/each}}
                    {{#if hasMoreThreads}}
                    <span class="thread-badge" style="background: #adb5bd;">+{{moreThreadCount}} more</span>
                    {{/if}}
                </div>
            </div>
        </details>
        {{/each}}
        {{#if hasMoreGroups}}
        <p style="color: #666; font-style: italic;">... and {{moreGroupCount}} more groups</p>
        {{/if}}
    </div>
    {{else}}
    <div class="card" style="background: #e9ecef;">
        <h2>No Similar Stack Groups</h2>
        <p>No groups of threads with similar entry points were found.</p>
    </div>
    {{/if}}

    {{#if hasJfrData}}
    <div class="card">
        <h2>JFR CPU Profiling</h2>
        <div class="chart-row">
            <div>
                <h3>Hottest Methods</h3>
                <table class="trend-table">
                    <thead><tr><th>Method</th><th>CPU %</th><th>Samples</th></tr></thead>
                    <tbody>
                        {{#each jfrAnalysis.hottestMethods}}
                        <tr>
                            <td><code>{{name}}</code></td>
                            <td>{{percentage}}%</td>
                            <td>{{sampleCount}}</td>
                        </tr>
                        {{/each}}
                    </tbody>
                </table>
            </div>
            <div>
                <h3>Hottest Threads</h3>
                <table class="trend-table">
                    <thead><tr><th>Thread</th><th>CPU %</th><th>Samples</th></tr></thead>
                    <tbody>
                        {{#each jfrAnalysis.hottestThreads}}
                        <tr>
                            <td>{{name}}</td>
                            <td>{{percentage}}%</td>
                            <td>{{sampleCount}}</td>
                        </tr>
                        {{/each}}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {{/if}}

    {{#if hasFindings}}
    <div class="card">
        <h2>Findings</h2>
        <ul class="findings-list">
            {{#each findings}}
            <li class="finding severity-{{lowercase severity}}">
                <div class="finding-header">
                    <span class="severity-badge severity-{{lowercase severity}}">{{severity}}</span>
                </div>
                <div class="finding-message">{{message}}</div>
            </li>
            {{/each}}
        </ul>
    </div>
    {{/if}}
</div>

{{#if hasGroups}}
<script>
{{#if hasEvolution}}
// Pattern Count Timeline
new Chart(document.getElementById('patternTimeline'), {
    type: 'line',
    data: {
        labels: [{{#each dumpLabels}}'Dump {{this}}'{{#unless @last}}, {{/unless}}{{/each}}],
        datasets: [{
            label: 'Entry Point Patterns',
            data: [{{#each patternCounts}}{{this}}{{#unless @last}}, {{/unless}}{{/each}}],
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            fill: true,
            tension: 0.3
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { title: { display: true, text: 'Entry Point Patterns Over Time' } },
        scales: {
            y: { beginAtZero: true, title: { display: true, text: 'Pattern Count' } }
        }
    }
});

// Thread Count Timeline
new Chart(document.getElementById('threadTimeline'), {
    type: 'line',
    data: {
        labels: [{{#each dumpLabels}}'Dump {{this}}'{{#unless @last}}, {{/unless}}{{/each}}],
        datasets: [{
            label: 'Threads in Patterns',
            data: [{{#each evolutionThreadCounts}}{{this}}{{#unless @last}}, {{/unless}}{{/each}}],
            borderColor: '#764ba2',
            backgroundColor: 'rgba(118, 75, 162, 0.1)',
            fill: true,
            tension: 0.3
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { title: { display: true, text: 'Threads in Patterns Over Time' } },
        scales: {
            y: { beginAtZero: true, title: { display: true, text: 'Thread Count' } }
        }
    }
});
{{/if}}
</script>
{{/if}}

{{> partials/footer}}
<script>
// Entry Point Bar Chart
new Chart(document.getElementById('entryPointBar'), {
    type: 'bar',
    data: {
        labels: [{{#each entryPointLabels}}'{{this}}'{{#unless @last}}, {{/unless}}{{/each}}],
        datasets: [{
            label: 'Thread Count',
            data: [{{#each threadCountData}}{{this}}{{#unless @last}}, {{/unless}}{{/each}}],
            backgroundColor: '#667eea'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: { title: { display: true, text: 'Threads by Entry Point' } }
    }
});

// Entry Point Pie Chart
new Chart(document.getElementById('entryPointPie'), {
    type: 'pie',
    data: {
        labels: [{{#each entryPointLabels}}'{{this}}'{{#unless @last}}, {{/unless}}{{/each}}],
        datasets: [{
            data: [{{#each threadCountData}}{{this}}{{#unless @last}}, {{/unless}}{{/each}}],
            backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe', '#43e97b', '#fa709a']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: 'right' },
            title: { display: true, text: 'Entry Point Distribution' }
        }
    }
});
</script>
{{/if}}
{{> partials/footer}}