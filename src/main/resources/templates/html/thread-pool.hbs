{{> partials/header}}
<header>
    <div class="container">
        <h1>Thread Pool Analysis</h1>
        <span class="severity-badge severity-{{lowercase severity}}">{{severity}}</span>
        {{#if isMultiDump}}<span class="severity-badge severity-info">Multi-Dump</span>{{/if}}
    </div>
</header>
<div class="container">
    <div class="card">
        <h2>Summary</h2>
        <div class="stat-grid">
            <div class="stat-item">
                <div class="stat-value">{{poolCount}}</div>
                <div class="stat-label">Pools Detected</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{totalPoolThreads}}</div>
                <div class="stat-label">Total Threads</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" {{#if hasExhausted}}style="color: var(--color-error);"{{/if}}>{{exhaustedPoolCount}}</div>
                <div class="stat-label">Exhausted</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{idlePoolCount}}</div>
                <div class="stat-label">Idle</div>
            </div>
        </div>
    </div>

    {{#if hasExhausted}}
    <div class="card" style="background: #f8d7da; border: 2px solid #dc3545;">
        <h2 style="color: #721c24;">âš  Exhausted Pools Detected</h2>
        <p>{{exhaustedPoolCount}} pool(s) are at or near full capacity. Tasks may be queued or rejected.</p>
    </div>
    {{/if}}

    {{#if hasPools}}
    <!-- Charts Section -->
    <div class="card">
        <h2>Pool Utilization</h2>
        <div class="chart-row">
            <div class="chart-container">
                <canvas id="poolStackedBar"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="utilizationBar"></canvas>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>Pool Details</h2>
        <table class="trend-table">
            <thead>
                <tr>
                    <th>Pool Name</th>
                    <th>Total</th>
                    <th>Active</th>
                    <th>Idle</th>
                    <th>Blocked</th>
                    <th>Utilization</th>
                    {{#if isMultiDump}}<th>Trend</th>{{/if}}
                </tr>
            </thead>
            <tbody>
                {{#each pools}}
                <tr {{#if isExhausted}}style="background: #fff3cd;"{{/if}}>
                    <td><strong>{{name}}</strong></td>
                    <td>{{totalThreads}}</td>
                    <td>{{activeThreads}}</td>
                    <td>{{idleThreads}}</td>
                    <td {{#ifGt blockedThreads 0}}style="color: var(--color-warning);"{{/ifGt}}>{{blockedThreads}}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="flex: 1; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden;">
                                <div style="height: 100%; width: {{utilization}}%; background: {{#if isExhausted}}#dc3545{{else}}{{#ifGte utilization 75}}#ffc107{{else}}#28a745{{/ifGte}}{{/if}};"></div>
                            </div>
                            <span>{{utilization}}%</span>
                        </div>
                    </td>
                    {{#if ../isMultiDump}}
                    <td class="{{#ifGt sizeChange 0}}change-up{{else}}{{#ifGt 0 sizeChange}}change-down{{else}}change-same{{/ifGt}}{{/ifGt}}">
                        {{sizeChangeDisplay}}
                    </td>
                    {{/if}}
                </tr>
                {{/each}}
            </tbody>
        </table>
    </div>

    {{#if isMultiDump}}
    <div class="card">
        <h2>Utilization Over Time</h2>
        <p style="color: #666;">Select a pool to view its utilization trend.</p>
        {{#each pools}}
        {{#if hasTrend}}
        <details style="margin-bottom: 12px;">
            <summary>{{name}}</summary>
            <div style="padding: 16px;">
                <div class="chart-container" style="height: 200px;">
                    <canvas id="pool-{{@index}}-chart"></canvas>
                </div>
            </div>
        </details>
        {{/if}}
        {{/each}}
    </div>
    {{/if}}
    {{else}}
    <div class="card" style="background: #e9ecef;">
        <h2>No Thread Pools Detected</h2>
        <p>No standard thread pool patterns (ExecutorService, ForkJoinPool, etc.) were found.</p>
    </div>
    {{/if}}

    {{#if hasFindings}}
    <div class="card">
        <h2>Findings</h2>
        <ul class="findings-list">
            {{#each findings}}
            <li class="finding severity-{{lowercase severity}}">
                <div class="finding-header">
                    <span class="severity-badge severity-{{lowercase severity}}">{{severity}}</span>
                </div>
                <div class="finding-message">{{message}}</div>
            </li>
            {{/each}}
        </ul>
    </div>
    {{/if}}
</div>

{{#if hasPools}}
<script>
// Pool Active/Idle Stacked Bar Chart
new Chart(document.getElementById('poolStackedBar'), {
    type: 'bar',
    data: {
        labels: [{{#each poolNames}}'{{this}}'{{#unless @last}}, {{/unless}}{{/each}}],
        datasets: [
            {
                label: 'Active',
                data: [{{#each activeData}}{{this}}{{#unless @last}}, {{/unless}}{{/each}}],
                backgroundColor: '#28a745'
            },
            {
                label: 'Idle',
                data: [{{#each idleData}}{{this}}{{#unless @last}}, {{/unless}}{{/each}}],
                backgroundColor: '#6c757d'
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { title: { display: true, text: 'Active vs Idle Threads' } },
        scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } }
    }
});

// Utilization Bar Chart
new Chart(document.getElementById('utilizationBar'), {
    type: 'bar',
    data: {
        labels: [{{#each poolNames}}'{{this}}'{{#unless @last}}, {{/unless}}{{/each}}],
        datasets: [{
            label: 'Utilization %',
            data: [{{#each pools}}{{utilization}}{{#unless @last}}, {{/unless}}{{/each}}],
            backgroundColor: [{{#each pools}}{{#if isExhausted}}'#dc3545'{{else}}{{#ifGte utilization 75}}'#ffc107'{{else}}'#28a745'{{/ifGte}}{{/if}}{{#unless @last}}, {{/unless}}{{/each}}]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { title: { display: true, text: 'Pool Utilization' } },
        scales: { y: { beginAtZero: true, max: 100 } }
    }
});

// Per-pool trend charts
{{#each pools}}
{{#if hasTrend}}
new Chart(document.getElementById('pool-{{@index}}-chart'), {
    type: 'line',
    data: {
        labels: [{{#each ../dumpLabels}}'Dump {{this}}'{{#unless @last}}, {{/unless}}{{/each}}],
        datasets: [
            {
                label: 'Utilization %',
                data: [{{#each utilHistory}}{{this}}{{#unless @last}}, {{/unless}}{{/each}}],
                borderColor: '#667eea',
                yAxisID: 'y'
            },
            {
                label: 'Total Threads',
                data: [{{#each totalHistory}}{{this}}{{#unless @last}}, {{/unless}}{{/each}}],
                borderColor: '#28a745',
                yAxisID: 'y1'
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: { type: 'linear', position: 'left', title: { display: true, text: 'Utilization %' }, max: 100 },
            y1: { type: 'linear', position: 'right', title: { display: true, text: 'Threads' }, grid: { drawOnChartArea: false } }
        }
    }
});
{{/if}}
{{/each}}
</script>
{{/if}}
{{> partials/footer}}
)