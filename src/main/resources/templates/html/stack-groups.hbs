{{> partials/header}}
<header>
    <div class="container">
        <h1>Identical Stack Analysis</h1>
        <span class="severity-badge severity-{{lowercase severity}}">{{severity}}</span>
        {{#if isMultiDump}}<span class="severity-badge severity-info">Multi-Dump</span>{{/if}}
    </div>
</header>
<div class="container">
    <div class="card">
        <h2>Summary</h2>
        <div class="stat-grid">
            <div class="stat-item">
                <div class="stat-value">{{groupCount}}</div>
                <div class="stat-label">Groups Found</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{totalGroupedThreads}}</div>
                <div class="stat-label">Total Threads</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{minGroupSize}}</div>
                <div class="stat-label">Min Group Size</div>
            </div>
            {{#if largestGroupSize}}
            <div class="stat-item">
                <div class="stat-value">{{largestGroupSize}}</div>
                <div class="stat-label">Largest Group</div>
            </div>
            {{/if}}
        </div>
    </div>

    {{#if hasEvolution}}
    <!-- Evolution Summary -->
    <div class="card">
        <h2>Group Evolution Summary</h2>
        <div class="stat-grid">
            <div class="stat-item">
                <div class="stat-value" style="{{#ifGt growingGroupCount 0}}color: var(--color-warning);{{/ifGt}}">{{growingGroupCount}}</div>
                <div class="stat-label">Growing Groups</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" style="{{#ifGt shrinkingGroupCount 0}}color: var(--color-ok);{{/ifGt}}">{{shrinkingGroupCount}}</div>
                <div class="stat-label">Shrinking Groups</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" style="{{#ifGt stuckGroupCount 0}}color: var(--color-error);{{/ifGt}}">{{stuckGroupCount}}</div>
                <div class="stat-label">Stuck Groups</div>
            </div>
        </div>
    </div>

    <!-- Evolution Timeline -->
    <div class="card">
        <h2>Stack Groups Over Time</h2>
        <div class="chart-row">
            <div class="chart-container">
                <canvas id="groupCountTimeline"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="threadCountTimeline"></canvas>
            </div>
        </div>
    </div>

    <!-- Evolving Groups Table -->
    <div class="card">
        <h2>Group Evolution Details</h2>
        <table class="trend-table">
            <thead>
                <tr>
                    <th>Stack Group</th>
                    <th>Trend</th>
                    <th>First Size</th>
                    <th>Last Size</th>
                    <th>Change</th>
                    <th>Dumps</th>
                    <th>Occurrences</th>
                </tr>
            </thead>
            <tbody>
                {{#each evolvingGroups}}
                <tr style="{{#if isGrowing}}background: #fff3cd;{{else}}{{#if isStuck}}background: #f8d7da;{{/if}}{{/if}}">
                    <td><code style="font-size: 0.85rem;">{{topFrame}}</code></td>
                    <td>
                        <span class="thread-badge {{#if isGrowing}}warning{{else}}{{#if isShrinking}}ok{{else}}{{#if isStuck}}error{{else}}info{{/if}}{{/if}}{{/if}}">
                            {{trend}}
                        </span>
                    </td>
                    <td>{{firstSize}}</td>
                    <td>{{lastSize}}</td>
                    <td>
                        <strong style="color: {{#if isGrowing}}#ffc107{{else}}{{#if isShrinking}}#28a745{{else}}#666{{/if}}{{/if}};">
                            {{sizeChangeDisplay}}
                        </strong>
                        {{#if growthRate}}({{growthRate}}%){{/if}}
                    </td>
                    <td>{{firstDump}} → {{lastDump}}</td>
                    <td>{{occurrences}}</td>
                </tr>
                {{/each}}
            </tbody>
        </table>
    </div>
    {{/if}}

    {{#each groups}}
    <div class="card">
        <h2>Group #{{index}} - {{threadCount}} threads</h2>
        <p><strong>Top Frame:</strong> <code style="background: #e9ecef; padding: 4px 8px; border-radius: 4px;">{{topFrame}}</code></p>
        <p><strong>Stack Depth:</strong> {{stackDepth}} frames</p>

        <h3 style="margin-top: 20px; margin-bottom: 12px;">Threads</h3>
        <div style="margin-bottom: 16px;">
            {{#each displayedThreadNames}}
            <span class="thread-badge">{{this}}</span>
            {{/each}}
            {{#if hasMoreThreads}}
            <span class="thread-badge" style="background: #adb5bd;">+{{moreThreadCount}} more</span>
            {{/if}}
        </div>

        <details>
            <summary>Stack Trace</summary>
            <div class="stack-trace">{{#each stackTrace}}{{this}}
{{/each}}</div>
        </details>
    </div>
    {{/each}}
    {{else}}
    <div class="card" style="background: #d4edda; border: 2px solid #28a745;">
        <h2 style="color: #155724;">✓ No Significant Thread Groupings</h2>
        <p>No groups of threads with identical stacks were found matching the criteria.</p>
    </div>
    {{/if}}

    {{#if hasFindings}}
    <div class="card">
        <h2>Findings</h2>
        <ul class="findings-list">
            {{#each findings}}
            <li class="finding severity-{{lowercase severity}}">
                <div class="finding-header">
                    <span class="severity-badge severity-{{lowercase severity}}">{{severity}}</span>
                    <span style="color: #666;">[{{category}}]</span>
                </div>
                <div class="finding-message">{{message}}</div>
            </li>
            {{/each}}
        </ul>
    </div>
    {{/if}}
</div>

{{#if hasGroups}}
<script>
{{#if hasEvolution}}
// Group Count Timeline
new Chart(document.getElementById('groupCountTimeline'), {
    type: 'line',
    data: {
        labels: [{{#each dumpLabels}}'Dump {{this}}'{{#unless @last}}, {{/unless}}{{/each}}],
        datasets: [{
            label: 'Stack Groups',
            data: [{{#each groupCounts}}{{this}}{{#unless @last}}, {{/unless}}{{/each}}],
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            fill: true,
            tension: 0.3
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { title: { display: true, text: 'Number of Stack Groups Over Time' } },
        scales: {
            y: { beginAtZero: true, title: { display: true, text: 'Group Count' } }
        }
    }
});

// Thread Count Timeline
new Chart(document.getElementById('threadCountTimeline'), {
    type: 'line',
    data: {
        labels: [{{#each dumpLabels}}'Dump {{this}}'{{#unless @last}}, {{/unless}}{{/each}}],
        datasets: [{
            label: 'Grouped Threads',
            data: [{{#each totalThreadCounts}}{{this}}{{#unless @last}}, {{/unless}}{{/each}}],
            borderColor: '#764ba2',
            backgroundColor: 'rgba(118, 75, 162, 0.1)',
            fill: true,
            tension: 0.3
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { title: { display: true, text: 'Grouped Threads Over Time' } },
        scales: {
            y: { beginAtZero: true, title: { display: true, text: 'Thread Count' } }
        }
    }
});
{{/if}}

// Group Size Bar Chart (current snapshot or all groups)
new Chart(document.getElementById('groupSizeBar'), {
    type: 'bar',
    data: {
        labels: [{{#each groups}}'Group #{{index}}'{{#unless @last}}, {{/unless}}{{/each}}],
        datasets: [{
            label: 'Thread Count',
            data: [{{#each groups}}{{threadCount}}{{#unless @last}}, {{/unless}}{{/each}}],
            backgroundColor: '#667eea'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false },
            title: { display: true, text: 'Threads per Stack Group' }
        },
        scales: {
            y: { beginAtZero: true, title: { display: true, text: 'Thread Count' } }
        }
    }
});

// Top Frame Distribution Pie
new Chart(document.getElementById('topFramePie'), {
    type: 'pie',
    data: {
        labels: [{{#each groups}}'{{truncate topFrame length=40}}'{{#unless @last}}, {{/unless}}{{/each}}],
        datasets: [{
            data: [{{#each groups}}{{threadCount}}{{#unless @last}}, {{/unless}}{{/each}}],
            backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe', '#43e97b', '#fa709a', '#fee140', '#ff9a9e']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: 'right' },
            title: { display: true, text: 'Threads by Top Frame' }
        }
    }
});
</script>
{{/if}}
{{> partials/footer}}