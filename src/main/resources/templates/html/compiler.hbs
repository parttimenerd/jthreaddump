{{> partials/header}}
<header>
    <div class="container">
        <h1>JIT Compiler Analysis</h1>
        <span class="severity-badge severity-{{lowercase severity}}">{{severity}}</span>
        {{#if isMultiDump}}<span class="severity-badge severity-info">Multi-Dump Temporal</span>{{/if}}
    </div>
</header>
<div class="container">
    {{#if hasData}}
    <div class="card">
        <h2>Summary</h2>
        <div class="stat-grid">
            <div class="stat-item">
                <div class="stat-value">{{compilerThreadCount}}</div>
                <div class="stat-label">Compiler Threads</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" {{#ifGt activeCompilerThreads 0}}style="color: var(--color-info);"{{/ifGt}}>{{activeCompilerThreads}}</div>
                <div class="stat-label">Active Compilers</div>
            </div>
            {{#if hasC1Activity}}
            <div class="stat-item">
                <div class="stat-value" style="color: #17a2b8;">{{activeC1Threads}}</div>
                <div class="stat-label">C1 Active</div>
            </div>
            {{/if}}
            {{#if hasC2Activity}}
            <div class="stat-item">
                <div class="stat-value" style="color: #667eea;">{{activeC2Threads}}</div>
                <div class="stat-label">C2 Active</div>
            </div>
            {{/if}}
            {{#if hasJfrData}}
            <div class="stat-item">
                <div class="stat-value" {{#ifGt totalCompilations 100}}style="color: var(--color-warning);"{{/ifGt}}>{{totalCompilations}}</div>
                <div class="stat-label">Total Compilations</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" {{#ifGt totalDeoptimizations 50}}style="color: var(--color-error);"{{/ifGt}}>{{totalDeoptimizations}}</div>
                <div class="stat-label">Deoptimizations</div>
            </div>
            {{/if}}
        </div>
    </div>

    {{#if hasTemporal}}
    <!-- Temporal Analysis -->
    <div class="card">
        <h2>Compiler Activity Trends</h2>

        <div class="stat-grid" style="margin-bottom: 20px;">
            {{#if compilationTrend}}
            <div class="stat-item">
                <div class="stat-value" style="color: {{#if compilationTrend.isIncreasing}}#ffc107{{else}}{{#if compilationTrend.isDecreasing}}#28a745{{else}}#17a2b8{{/if}}{{/if}};">
                    {{#if compilationTrend.isIncreasing}}↑{{else}}{{#if compilationTrend.isDecreasing}}↓{{else}}→{{/if}}{{/if}}
                </div>
                <div class="stat-label">{{compilationTrend.direction}}</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{compilationTrend.changeRate}}%</div>
                <div class="stat-label">Compilation Change</div>
            </div>
            {{/if}}
            {{#if deoptTrend}}
            <div class="stat-item">
                <div class="stat-value" style="color: {{#if deoptTrend.isIncreasing}}#dc3545{{else}}{{#if deoptTrend.isDecreasing}}#28a745{{else}}#17a2b8{{/if}}{{/if}};">
                    {{deoptTrend.direction}}
                </div>
                <div class="stat-label">Deopt Trend</div>
            </div>
            {{/if}}
        </div>

        <div class="chart-row">
            {{#if compilationTrend}}
            <div class="chart-container">
                <canvas id="compilationTrendChart"></canvas>
            </div>
            {{/if}}
            {{#if deoptTrend}}
            <div class="chart-container">
                <canvas id="deoptTrendChart"></canvas>
            </div>
            {{/if}}
        </div>

        {{#if activeThreadsTrend}}
        <div class="chart-row" style="margin-top: 20px;">
            <div class="chart-container">
                <canvas id="activeThreadsChart"></canvas>
            </div>
        </div>
        {{/if}}
    </div>
    {{/if}}

    {{#if hasCompilerThreads}}
    <div class="card">
        <h2>Compiler Threads</h2>
        <table class="trend-table">
            <thead><tr><th>Thread Name</th><th>Type</th><th>State</th></tr></thead>
            <tbody>
                {{#each compilerThreads}}
                <tr {{#if isActive}}style="background: #e6f7ff;"{{/if}}>
                    <td><code>{{name}}</code></td>
                    <td>
                        {{#if (contains name "C1")}}
                        <span class="thread-badge info">C1</span>
                        {{else}}{{#if (contains name "C2")}}
                        <span class="thread-badge ok">C2</span>
                        {{else}}{{#if (contains name "JVMCI")}}
                        <span class="thread-badge warning">JVMCI</span>
                        {{else}}
                        <span class="thread-badge">JIT</span>
                        {{/if}}{{/if}}{{/if}}
                    </td>
                    <td>
                        <span class="thread-badge {{#if isActive}}info{{else}}ok{{/if}}">
                            {{state}}
                        </span>
                    </td>
                </tr>
                {{/each}}
            </tbody>
        </table>
    </div>
    {{/if}}

    {{#if hasCompilations}}
    <div class="card">
        <h2>Top Compilations</h2>
        <table class="trend-table">
            <thead><tr><th>Method</th><th>Level</th><th>Duration</th><th>Status</th></tr></thead>
            <tbody>
                {{#each topCompilations}}
                <tr>
                    <td><code title="{{fullMethod}}">{{method}}</code></td>
                    <td>{{level}}</td>
                    <td>{{formatDuration durationMs}}</td>
                    <td>
                        {{#if success}}
                        <span class="thread-badge ok">✓</span>
                        {{else}}
                        <span class="thread-badge error">✗</span>
                        {{/if}}
                    </td>
                </tr>
                {{/each}}
            </tbody>
        </table>
    </div>
    {{/if}}

    {{#if hasDeopts}}
    <div class="card">
        <h2>Deoptimizations</h2>
        <table class="trend-table">
            <thead><tr><th>Method</th><th>Reason</th><th>Action</th></tr></thead>
            <tbody>
                {{#each topDeoptimizations}}
                <tr style="background: #fff3cd;">
                    <td><code title="{{fullMethod}}">{{method}}</code></td>
                    <td>{{reason}}</td>
                    <td>{{action}}</td>
                </tr>
                {{/each}}
            </tbody>
        </table>
    </div>
    {{/if}}

    {{else}}
    <div class="card" style="background: #e9ecef;">
        <h2>No Compiler Activity Detected</h2>
        <p>No compiler threads found. This may be normal for a small application or if the JVM has finished initial compilation.</p>
        {{#unless hasJfrData}}
        <p><em>Note: JFR data not available. Detailed compilation analysis requires JFR file.</em></p>
        {{/unless}}
    </div>
    {{/if}}

    {{#if hasFindings}}
    <div class="card">
        <h2>Findings</h2>
        <ul class="findings-list">
            {{#each findings}}
            <li class="finding severity-{{lowercase severity}}">
                <div class="finding-header">
                    <span class="severity-badge severity-{{lowercase severity}}">{{severity}}</span>
                </div>
                <div class="finding-message">{{message}}</div>
            </li>
            {{/each}}
        </ul>
    </div>
    {{/if}}
</div>

{{#if hasData}}
<script>
{{#if hasTemporal}}
{{#if compilationTrend}}
// Compilation Trend Chart
new Chart(document.getElementById('compilationTrendChart'), {
    type: 'line',
    data: {
        labels: [{{#each dumpLabels}}'Dump {{this}}'{{#unless @last}}, {{/unless}}{{/each}}],
        datasets: [{
            label: 'Compilations',
            data: [{{#each compilationsPerDump}}{{this}}{{#unless @last}}, {{/unless}}{{/each}}],
            borderColor: '{{#if compilationTrend.isIncreasing}}#ffc107{{else}}{{#if compilationTrend.isDecreasing}}#28a745{{else}}#667eea{{/if}}{{/if}}',
            backgroundColor: '{{#if compilationTrend.isIncreasing}}rgba(255, 193, 7, 0.1){{else}}{{#if compilationTrend.isDecreasing}}rgba(40, 167, 69, 0.1){{else}}rgba(102, 126, 234, 0.1){{/if}}{{/if}}',
            fill: true,
            tension: 0.3
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            title: {
                display: true,
                text: 'Compilation Trend: {{compilationTrend.direction}} ({{compilationTrend.changeRate}}%)'
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                title: { display: true, text: 'Compilations' }
            }
        }
    }
});
{{/if}}

{{#if deoptTrend}}
// Deoptimization Trend Chart
new Chart(document.getElementById('deoptTrendChart'), {
    type: 'line',
    data: {
        labels: [{{#each dumpLabels}}'Dump {{this}}'{{#unless @last}}, {{/unless}}{{/each}}],
        datasets: [{
            label: 'Deoptimizations',
            data: [{{#each deoptsPerDump}}{{this}}{{#unless @last}}, {{/unless}}{{/each}}],
            borderColor: '{{#if deoptTrend.isIncreasing}}#dc3545{{else}}{{#if deoptTrend.isDecreasing}}#28a745{{else}}#f5576c{{/if}}{{/if}}',
            backgroundColor: '{{#if deoptTrend.isIncreasing}}rgba(220, 53, 69, 0.1){{else}}{{#if deoptTrend.isDecreasing}}rgba(40, 167, 69, 0.1){{else}}rgba(245, 87, 108, 0.1){{/if}}{{/if}}',
            fill: true,
            tension: 0.3
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            title: {
                display: true,
                text: 'Deoptimization Trend: {{deoptTrend.direction}} ({{deoptTrend.changeRate}}%)'
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                title: { display: true, text: 'Deoptimizations' }
            }
        }
    }
});
{{/if}}

{{#if activeThreadsTrend}}
// Active Compiler Threads Chart
new Chart(document.getElementById('activeThreadsChart'), {
    type: 'line',
    data: {
        labels: [{{#each dumpLabels}}'Dump {{this}}'{{#unless @last}}, {{/unless}}{{/each}}],
        datasets: [{
            label: 'Active Compiler Threads',
            data: [{{#each activeThreadsPerDump}}{{this}}{{#unless @last}}, {{/unless}}{{/each}}],
            borderColor: '#17a2b8',
            backgroundColor: 'rgba(23, 162, 184, 0.1)',
            fill: true,
            tension: 0.3
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            title: {
                display: true,
                text: 'Active Compiler Threads: {{activeThreadsTrend.direction}}'
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                title: { display: true, text: 'Active Threads' }
            }
        }
    }
});
{{/if}}
{{/if}}
</script>
{{/if}}

{{> partials/footer}}