{{> partials/header}}
<header>
    <div class="container">
        <h1>Lock Contention Analysis</h1>
        <span class="severity-badge severity-{{lowercase severity}}">{{severity}}</span>
    </div>
</header>
<div class="container">
    <div class="card">
        <h2>Summary</h2>
        <div class="stat-grid">
            <div class="stat-item">
                <div class="stat-value" {{#ifGt totalContentedLocks 0}}style="color: var(--color-warning);"{{/ifGt}}>{{totalContentedLocks}}</div>
                <div class="stat-label">Contended Locks</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" {{#ifGt hotLocks 0}}style="color: var(--color-error);"{{/ifGt}}>{{hotLocks}}</div>
                <div class="stat-label">Hot Locks (5+ waiters)</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{maxWaiters}}</div>
                <div class="stat-label">Max Waiters</div>
            </div>
        </div>
    </div>

    {{#if hasContention}}
    <!-- Lock Contention Charts -->
    <div class="card">
        <h2>Lock Contention Visualization</h2>
        <div class="chart-row">
            <div class="chart-container">
                <canvas id="waiterDistributionBar"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="lockClassPie"></canvas>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>Lock Contention Details</h2>
        {{#each contentions}}
        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid {{#ifGte waiterCount 5}}var(--color-error){{else}}{{#ifGte waiterCount 2}}var(--color-warning){{else}}var(--color-info){{/ifGte}}{{/ifGte}};">
            <p><strong>Lock:</strong> <code style="background: #e9ecef; padding: 4px 8px; border-radius: 4px;">{{lockId}}</code></p>
            <p><strong>Class:</strong> {{lockClassName}}</p>
            {{#if hasOwner}}
            <p><strong>Owner:</strong> {{owner.name}} <span class="thread-badge {{lowercase owner.state}}">{{owner.state}}</span></p>
            {{else}}
            <p><strong>Owner:</strong> <em>unknown</em></p>
            {{/if}}
            <p><strong>Waiters:</strong> <span class="severity-badge {{#ifGte waiterCount 5}}severity-error{{else}}{{#ifGte waiterCount 2}}severity-warning{{else}}severity-info{{/ifGte}}{{/ifGte}}">{{waiterCount}}</span></p>
            <details style="margin-top: 10px;">
                <summary>Waiting Threads</summary>
                <div style="padding: 10px;">
                    {{#each waiters}}
                    <span class="thread-badge {{lowercase state}}">{{name}}</span>
                    {{/each}}
                    {{#if hasMoreWaiters}}
                    <span class="thread-badge">+{{moreWaiterCount}} more</span>
                    {{/if}}
                </div>
            </details>
        </div>
        {{/each}}
        {{#if hasMoreContentions}}
        <p style="color: #666; font-style: italic;">... and {{moreContentionCount}} more contended locks</p>
        {{/if}}
    </div>
    {{else}}
    <div class="card" style="background: #d4edda; border: 2px solid #28a745;">
        <h2 style="color: #155724;">âœ“ No Significant Lock Contention</h2>
        <p>The analyzed thread dump(s) show no significant lock contention issues.</p>
    </div>
    {{/if}}

    {{#if hasJfrData}}
    <div class="card">
        <h2>JFR Lock Analysis</h2>
        <div class="stat-grid">
            <div class="stat-item">
                <div class="stat-value">{{jfrAnalysis.totalEvents}}</div>
                <div class="stat-label">Total Lock Events</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{jfrAnalysis.uniqueLocks}}</div>
                <div class="stat-label">Unique Locks</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{formatDuration jfrAnalysis.totalBlockedMs}}</div>
                <div class="stat-label">Total Blocked Time</div>
            </div>
        </div>
    </div>
    {{/if}}

    {{#if hasFindings}}
    <div class="card">
        <h2>Findings</h2>
        <ul class="findings-list">
            {{#each findings}}
            <li class="finding severity-{{lowercase severity}}">
                <div class="finding-header">
                    <span class="severity-badge severity-{{lowercase severity}}">{{severity}}</span>
                    <span style="color: #666;">[{{category}}]</span>
                </div>
                <div class="finding-message">{{message}}</div>
            </li>
            {{/each}}
        </ul>
    </div>
    {{/if}}
</div>

{{#if hasContention}}
<script>
// Waiter Distribution Bar Chart
new Chart(document.getElementById('waiterDistributionBar'), {
    type: 'bar',
    data: {
        labels: [{{#each contentions}}'{{lockId}}'{{#unless @last}}, {{/unless}}{{/each}}],
        datasets: [{
            label: 'Waiter Count',
            data: [{{#each contentions}}{{waiterCount}}{{#unless @last}}, {{/unless}}{{/each}}],
            backgroundColor: [{{#each contentions}}{{#ifGte waiterCount 5}}'#dc3545'{{else}}{{#ifGte waiterCount 2}}'#ffc107'{{else}}'#17a2b8'{{/ifGte}}{{/ifGte}}{{#unless @last}}, {{/unless}}{{/each}}]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false },
            title: { display: true, text: 'Waiters per Lock' }
        },
        scales: {
            y: { beginAtZero: true, title: { display: true, text: 'Waiter Count' } },
            x: { ticks: { maxRotation: 45 } }
        }
    }
});

// Lock Class Distribution Pie Chart
const lockClasses = {};
{{#each contentions}}
lockClasses['{{lockClassName}}'] = (lockClasses['{{lockClassName}}'] || 0) + {{waiterCount}};
{{/each}}
new Chart(document.getElementById('lockClassPie'), {
    type: 'pie',
    data: {
        labels: Object.keys(lockClasses),
        datasets: [{
            data: Object.values(lockClasses),
            backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: 'right' },
            title: { display: true, text: 'Contention by Lock Class' }
        }
    }
});
</script>
{{/if}}
{{> partials/footer}}