{{> partials/header}}
<header>
    <div class="container">
        <h1>Deadlock Analysis</h1>
        <span class="severity-badge severity-{{lowercase severity}}">{{severity}}</span>
        {{#if isMultiDump}}<span class="severity-badge severity-info">Multi-Dump</span>{{/if}}
    </div>
</header>
<div class="container">
    {{#if hasDeadlocks}}
    <div class="card" style="background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%); border: 2px solid #ffc107;">
        <h2 style="color: #856404;">âš  Deadlocks Detected!</h2>
        <div class="stat-grid">
            <div class="stat-item">
                <div class="stat-value" style="color: #dc3545;">{{deadlockCount}}</div>
                <div class="stat-label">Total Deadlocks</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{jvmReportedCount}}</div>
                <div class="stat-label">JVM Reported</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{maxCycleSize}}</div>
                <div class="stat-label">Max Cycle Size</div>
            </div>
            {{#if hasPersistentDeadlocks}}
            <div class="stat-item">
                <div class="stat-value" style="color: #dc3545;">{{maxOccurrences}}</div>
                <div class="stat-label">Max Occurrences</div>
            </div>
            {{/if}}
        </div>
    </div>

    {{#if hasPersistenceData}}
    {{#if isMultiDump}}
    <div class="card">
        <h2>Multi-Dump Trend Analysis</h2>
        <div class="stat-grid">
            <div class="stat-item">
                <div class="stat-value" style="color: {{#ifEq overallTrend "ALL CLEAR"}}#28a745{{else}}{{#ifEq overallTrend "IMPROVING - RESOLVED"}}#28a745{{else}}#dc3545{{/ifEq}}{{/ifEq}};">
                    {{#ifEq overallTrend "ALL CLEAR"}}âœ“{{else}}{{#ifEq overallTrend "IMPROVING - RESOLVED"}}â†“{{else}}âš {{/ifEq}}{{/ifEq}}
                </div>
                <div class="stat-label">{{overallTrend}}</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" style="color: #dc3545;">{{dumpsWithDeadlocks}}</div>
                <div class="stat-label">Dumps with Deadlocks</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" style="color: #28a745;">{{dumpsClear}}</div>
                <div class="stat-label">Dumps Clear</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{totalDumps}}</div>
                <div class="stat-label">Total Dumps</div>
            </div>
        </div>

        <h3 style="margin-top: 20px; margin-bottom: 12px;">Per-Dump Timeline</h3>
        <table class="trend-table">
            <thead>
                <tr>
                    <th>Dump</th>
                    <th>Status</th>
                    <th>Deadlock Count</th>
                    <th>Trend</th>
                </tr>
            </thead>
            <tbody>
                {{#each dumpLabels}}
                <tr style="{{#ifEq ../deadlockCounts.[@index] 0}}background: #d4edda;{{else}}background: #f8d7da;{{/ifEq}}">
                    <td><strong>Dump {{this}}</strong></td>
                    <td>
                        <span class="thread-badge {{#ifEq ../deadlockCounts.[@index] 0}}ok{{else}}error{{/ifEq}}">
                            {{../dumpStatus.[@index]}}
                        </span>
                    </td>
                    <td>{{../deadlockCounts.[@index]}}</td>
                    <td>
                        {{#if @index}}
                            {{#ifGt ../deadlockCounts.[@index] ../deadlockCounts.[subtract @index 1]}}
                                <span style="color: #dc3545;">â†‘ Worsening</span>
                            {{else}}{{#ifEq ../deadlockCounts.[@index] ../deadlockCounts.[subtract @index 1]}}
                                {{#ifEq ../deadlockCounts.[@index] 0}}
                                    <span style="color: #28a745;">â†’ Still Clear</span>
                                {{else}}
                                    <span style="color: #ffc107;">â†’ Persistent</span>
                                {{/ifEq}}
                            {{else}}
                                <span style="color: #28a745;">â†“ Improving</span>
                            {{/ifEq}}{{/ifGt}}
                        {{else}}
                            <span style="color: #666;">â€” Baseline</span>
                        {{/if}}
                    </td>
                </tr>
                {{/each}}
            </tbody>
        </table>
    </div>
    {{/if}}

    {{#if hasPersistentDeadlocks}}
    <div class="card" style="background: #f8d7da; border: 2px solid #dc3545;">
        <h2 style="color: #721c24;">Deadlock Lifecycle Analysis</h2>
        <p style="color: #721c24;">Tracking when deadlocks appear, persist, and resolve:</p>

        <table class="trend-table" style="margin-top: 16px;">
            <thead>
                <tr>
                    <th>Involved Threads</th>
                    <th>Lifecycle</th>
                    <th>Persistence</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {{#each persistentDeadlocks}}
                <tr style="{{#if isResolved}}background: #d4edda;{{else}}{{#if isPersistent}}background: #fff3cd;{{else}}background: #ffeeba;{{/if}}{{/if}}">
                    <td>{{#each threadNames}}<span class="thread-badge">{{this}}</span>{{/each}}</td>
                    <td>
                        Dumps {{firstSeen}} â†’ {{lastSeen}}<br>
                        <small>({{occurrences}} occurrence{{#ifGt occurrences 1}}s{{/ifGt}}, span: {{dumpSpan}} dumps)</small>
                    </td>
                    <td><strong>{{persistencePercent}}</strong></td>
                    <td>
                        <span class="severity-badge severity-{{#if isResolved}}ok{{else}}{{#ifEq status "ONGOING CRITICAL"}}error{{else}}warning{{/ifEq}}{{/if}}">
                            {{status}}
                        </span>
                        {{#if appearedLater}}
                            <br><small style="color: #ffc107;">âš  New deadlock</small>
                        {{/if}}
                        {{#if isResolved}}
                            <br><small style="color: #28a745;">âœ“ Resolved</small>
                        {{/if}}
                        {{#if isOngoing}}{{#unless isResolved}}
                            <br><small style="color: #dc3545;">ðŸ”´ Still active</small>
                        {{/unless}}{{/if}}
                    </td>
                </tr>
                {{/each}}
            </tbody>
        </table>
    </div>
    {{/if}}

    {{#if isMultiDump}}
    <div class="card">
        <h2>Deadlock Occurrences Over Time</h2>
        <div class="chart-container" style="height: 300px;">
            <canvas id="deadlockTimelineChart"></canvas>
        </div>
    </div>
    {{/if}}
    {{/if}}

    {{#each deadlocks}}
    <div class="card">
        <h2>Deadlock #{{index}} {{#if jvmReported}}<span class="severity-badge severity-info">JVM Reported</span>{{/if}}</h2>
        <p><strong>Threads involved:</strong> {{threadCount}}</p>
        <p><strong>Thread names:</strong> {{#each threadNames}}<span class="thread-badge blocked">{{this}}</span>{{/each}}</p>

        <h3 style="margin-top: 20px; margin-bottom: 12px;">Wait Chain</h3>
        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
            {{#each threads}}
            <div style="margin-bottom: 20px; padding-left: 20px; border-left: 3px solid #dc3545;">
                <p><strong style="font-size: 1.1rem;">â†’ {{name}}</strong></p>
                <p>State: <span class="thread-badge {{lowercase state}}">{{state}}</span></p>
                {{#if waitingForLock}}
                <p>Waiting for lock: <code style="background: #e9ecef; padding: 4px 8px; border-radius: 4px;">{{waitingForLock}}</code>
                    {{#if waitingForClass}}({{waitingForClass}}){{/if}}
                </p>
                {{/if}}
                {{#if heldLocks.length}}
                <p>Holding locks:
                    {{#each heldLocks}}
                    <code style="background: #d4edda; padding: 4px 8px; border-radius: 4px; margin: 2px;">{{this}}</code>
                    {{/each}}
                </p>
                {{/if}}
                {{#if stackTrace}}
                <details style="margin-top: 12px;">
                    <summary>Stack Trace</summary>
                    <div class="stack-trace">{{#each stackTrace}}{{this}}
{{/each}}</div>
                </details>
                {{/if}}
            </div>
            {{/each}}
        </div>
    </div>
    {{/each}}
    {{else}}
    <div class="card" style="background: #d4edda; border: 2px solid #28a745;">
        <h2 style="color: #155724;">âœ“ No Deadlocks Detected</h2>
        <p>The analyzed thread dump(s) show no deadlock conditions.</p>

        <!-- Healthy status chart -->
        <div class="chart-container" style="height: 200px; margin-top: 20px;">
            <canvas id="healthyStatusChart"></canvas>
        </div>
    </div>
    {{/if}}

    {{#if hasFindings}}
    <div class="card">
        <h2>Findings</h2>
        <ul class="findings-list">
            {{#each findings}}
            <li class="finding severity-{{lowercase severity}}">
                <div class="finding-header">
                    <span class="severity-badge severity-{{lowercase severity}}">{{severity}}</span>
                    <span style="color: #666;">[{{category}}]</span>
                </div>
                <div class="finding-message">{{message}}</div>
            </li>
            {{/each}}
        </ul>
    </div>
    {{/if}}
</div>

<script>
{{#if hasDeadlocks}}
{{#if isMultiDump}}
// Deadlock Timeline Chart
new Chart(document.getElementById('deadlockTimelineChart'), {
    type: 'line',
    data: {
        labels: [{{#each dumpLabels}}'Dump {{this}}'{{#unless @last}}, {{/unless}}{{/each}}],
        datasets: [{
            label: 'Deadlocks Detected',
            data: [{{#each deadlockCounts}}{{this}}{{#unless @last}}, {{/unless}}{{/each}}],
            borderColor: '#dc3545',
            backgroundColor: 'rgba(220, 53, 69, 0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 6,
            pointHoverRadius: 8
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            title: { display: true, text: 'Deadlock Occurrences Across Dumps' },
            legend: { display: false }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: { stepSize: 1 },
                title: { display: true, text: 'Number of Deadlocks' }
            },
            x: {
                title: { display: true, text: 'Thread Dump' }
            }
        }
    }
});
{{/if}}
{{else}}
// Healthy status chart
new Chart(document.getElementById('healthyStatusChart'), {
    type: 'doughnut',
    data: {
        labels: ['Healthy', 'No Deadlocks'],
        datasets: [{
            data: [100, 0],
            backgroundColor: ['#28a745', '#e9ecef']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false },
            title: { display: true, text: 'Deadlock Status: All Clear âœ“' }
        }
    }
});
{{/if}}
</script>
{{> partials/footer}}