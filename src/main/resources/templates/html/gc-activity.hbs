{{> partials/header}}
<header>
    <div class="container">
        <h1>GC Activity Analysis</h1>
        <span class="severity-badge severity-{{lowercase severity}}">{{severity}}</span>
        {{#if isMultiDump}}<span class="severity-badge severity-info">{{snapshotCount}} Dumps</span>{{/if}}
    </div>
</header>
<div class="container">
    <div class="card">
        <h2>Summary</h2>
        <div class="stat-grid">
            <div class="stat-item">
                <div class="stat-value" {{#if highGcCpu}}style="color: var(--color-warning);"{{/if}}>{{avgGcCpuPercentage}}%</div>
                <div class="stat-label">Avg GC CPU</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{maxGcCpuPercentage}}%</div>
                <div class="stat-label">Max GC CPU</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{maxRunnableGcThreads}}</div>
                <div class="stat-label">Max Active GC</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" {{#if potentialSTW}}style="color: var(--color-error);"{{/if}}>{{maxThreadsAtSafepoint}}</div>
                <div class="stat-label">Max at Safepoint</div>
            </div>
        </div>
    </div>

    {{#if potentialSTW}}
    <div class="card" style="background: #f8d7da; border: 2px solid #dc3545;">
        <h2 style="color: #721c24;">⚠ Potential Stop-The-World GC Pause</h2>
        <p>A high percentage of application threads were found at safepoint, indicating a possible STW GC pause.</p>
    </div>
    {{/if}}

    {{#if highGcCpu}}
    <div class="card" style="background: #fff3cd; border: 2px solid #ffc107;">
        <h2 style="color: #856404;">⚠ High GC CPU Usage</h2>
        <p>GC threads are consuming more than 20% of available CPU time.</p>
    </div>
    {{/if}}

    {{#if isMultiDump}}
    <!-- Charts Section -->
    <div class="card">
        <h2>GC Activity Over Time</h2>
        <div class="chart-row">
            <div class="chart-container">
                <canvas id="gcCpuLineChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="safepointBarChart"></canvas>
            </div>
        </div>
    </div>

    <!-- GC vs App CPU Distribution -->
    <div class="card">
        <h2>CPU Distribution</h2>
        <div class="chart-container" style="height: 250px;">
            <canvas id="cpuDistributionPie"></canvas>
        </div>
    </div>

    {{#if trendData}}
    <div class="card">
        <h2>Trend Summary</h2>
        <table class="trend-table">
            <thead>
                <tr><th>Metric</th><th>First Dump</th><th>Last Dump</th><th>Change</th></tr>
            </thead>
            <tbody>
                {{#each trendData}}
                <tr>
                    <td>{{metric}}</td>
                    <td>{{first}}</td>
                    <td>{{last}}</td>
                    <td class="{{changeClass}}">{{changeDisplay}}</td>
                </tr>
                {{/each}}
            </tbody>
        </table>
    </div>
    {{/if}}

    <div class="card">
        <h2>Per-Dump Snapshots</h2>
        <table class="trend-table">
            <thead>
                <tr>
                    <th>Dump</th>
                    <th>GC Threads</th>
                    <th>Active GC</th>
                    <th>App Threads</th>
                    <th>Safepoint</th>
                    <th>GC CPU %</th>
                </tr>
            </thead>
            <tbody>
                {{#each snapshots}}
                <tr>
                    <td>{{dumpIndex}}</td>
                    <td>{{gcThreadCount}}</td>
                    <td>{{runnableGcThreads}}</td>
                    <td>{{appThreadCount}}</td>
                    <td {{#ifGt threadsAtSafepoint 5}}style="color: var(--color-warning);"{{/ifGt}}>{{threadsAtSafepoint}}</td>
                    <td {{#ifGt gcCpuPercentage 20}}style="color: var(--color-warning);"{{/ifGt}}>{{gcCpuPercentage}}%</td>
                </tr>
                {{/each}}
            </tbody>
        </table>
    </div>
    {{/if}}

    {{#unless hasIssues}}
    <div class="card" style="background: #d4edda; border: 2px solid #28a745;">
        <h2 style="color: #155724;">✓ No Significant GC Issues</h2>
        <p>GC activity appears normal with no concerning patterns detected.</p>
    </div>
    {{/unless}}

    {{#if hasFindings}}
    <div class="card">
        <h2>Findings</h2>
        <ul class="findings-list">
            {{#each findings}}
            <li class="finding severity-{{lowercase severity}}">
                <div class="finding-header">
                    <span class="severity-badge severity-{{lowercase severity}}">{{severity}}</span>
                </div>
                <div class="finding-message">{{message}}</div>
            </li>
            {{/each}}
        </ul>
    </div>
    {{/if}}
</div>

{{#if isMultiDump}}
<script>
// GC CPU Line Chart
new Chart(document.getElementById('gcCpuLineChart'), {
    type: 'line',
    data: {
        labels: [{{#each dumpLabels}}'Dump {{this}}'{{#unless @last}}, {{/unless}}{{/each}}],
        datasets: [{
            label: 'GC CPU %',
            data: [{{#each gcCpuData}}{{this}}{{#unless @last}}, {{/unless}}{{/each}}],
            borderColor: '#dc3545',
            backgroundColor: 'rgba(220, 53, 69, 0.1)',
            fill: true,
            tension: 0.3
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { title: { display: true, text: 'GC CPU Usage Over Time' } },
        scales: { y: { beginAtZero: true, max: 100, title: { display: true, text: 'CPU %' } } }
    }
});

// Safepoint Bar Chart
new Chart(document.getElementById('safepointBarChart'), {
    type: 'bar',
    data: {
        labels: [{{#each dumpLabels}}'Dump {{this}}'{{#unless @last}}, {{/unless}}{{/each}}],
        datasets: [{
            label: 'Threads at Safepoint',
            data: [{{#each safepointData}}{{this}}{{#unless @last}}, {{/unless}}{{/each}}],
            backgroundColor: '#ffc107'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { title: { display: true, text: 'Threads at Safepoint' } },
        scales: { y: { beginAtZero: true } }
    }
});

// CPU Distribution Pie
new Chart(document.getElementById('cpuDistributionPie'), {
    type: 'doughnut',
    data: {
        labels: ['GC CPU', 'Application CPU'],
        datasets: [{
            data: [{{avgGcCpuPercentage}}, {{100 - avgGcCpuPercentage}}],
            backgroundColor: ['#dc3545', '#28a745']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { title: { display: true, text: 'Average CPU Distribution' } }
    }
});
</script>
{{/if}}
{{> partials/footer}}